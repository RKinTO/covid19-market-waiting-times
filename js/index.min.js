/*! covid19-market-waiting-times 2020-04-20 */
const API_DOMAIN_AVAILABLE=["api-geo-fr","api-geo-ny"],API_DOMAIN=API_DOMAIN_AVAILABLE[Math.floor(Math.random()*API_DOMAIN_AVAILABLE.length)],WaitingTimesAPI={fallbackGeocodeAPI:"https://nominatim.openstreetmap.org/search.php?q=%s&format=json",geocodeAPI:"https://api-geo.thejoin.tech/geocode?lat=%s&lng=%s",geocodeAPIClient:"https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/reverseGeocode?f=pjson&featureTypes=&location=%s,%s",logAPI:"https://api-geo.thejoin.tech/logger",feedbackAPI:"https://api-geo-fr.thejoin.tech/send-feedback",getPlaceByNameAPI:"https://api-geo-ny.thejoin.tech/places/get-by-name?q=%s&address=%s",getPlacesAPI:"https://"+API_DOMAIN+".thejoin.tech/places/explore?q=%s&address=%s",getPlacesAPIFallback:"https://api-geo-fr.thejoin.tech/places/explore-redis?q=%s&address=%s",searchSuggestAPI:"https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/suggest?text=%s&maxSuggestions=10&category=city,address&countryCode=&searchExtent=&location=&distance=&f=json",format:function(e){var t=[].slice.call(arguments,1),a=0;return e.replace(/%s/g,()=>t[a++])}};Number.prototype.toRad=function(){return this*Math.PI/180},Number.prototype.toDeg=function(){return 180*this/Math.PI};const Utils={updateTimeout:null,geoErrorTimeout:null,geoErrorFailOverCount:0,sendFeedback:function(e){fetch(WaitingTimesAPI.feedbackAPI,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)})},sendError:function(e){e.ua=navigator.userAgent,e.date=(new Date).toString(),fetch(WaitingTimesAPI.logAPI,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)})},searchSuggest:async function(e){if(e.value.length>3){var t=WaitingTimesAPI.format(WaitingTimesAPI.searchSuggestAPI,e.value),a=await fetch(t);if(a.ok){var s=await a.json(),i=[];if(s.suggestions.length>0)for(let e in s.suggestions)i.push(s.suggestions[e].text)}}},setDefaultLocation:function(e,t,a){var s={address:e,latt:t,longt:a};localStorage.setItem("defaultLocation",JSON.stringify(s))},getDefaultLocation:function(){return JSON.parse(localStorage.getItem("defaultLocation"))},shouldShowWelcomeModal:function(){var e=window.localStorage.getItem("hasSeenWelcomeModal");return!e||"true"!==e},showWelcomeModal:function(){var e=document.getElementById("welcome-modal");e.classList.add("show"),e.focus(),null!==TimesApp.lMap&&(document.querySelector(".welcome-modal__actions").style.display="none")},hideWelcomeModal:function(){document.getElementById("welcome-modal").classList.remove("show"),null===TimesApp.lMap&&(window.localStorage.setItem("hasSeenWelcomeModal","true"),TimesApp.initGeodata())},showPlaceSidebar:function(){var e=document.getElementById("places-sidebar");e.classList.add("show"),e.focus();var t=document.querySelector(".sidebar__items");if(t.innerHTML="",Object.keys(TimesApp.menuPlaces).length>0)for(let e in TimesApp.menuPlaces){var a=TimesApp.menuPlaces[e].data,s=TimesApp.menuPlaces[e].waitTimeArr,i="recent";if(void 0!==a.updatetime){var n=new Date(1e3*a.updatetime);i=n.getHours()+":"+("0"+n.getMinutes()).substr(-2)}var o=s[1],r=0===s[0],l="string"==typeof o&&!r;o=r?"Closed":o;var p=r?"Closed":o+" min";p=l?"No info":p;var d=document.createElement("h2");d.className="sidebar__item--title sidebar__item--title--bg-"+o.toString().toLowerCase()+"min",d.innerHTML=a.name;var c=document.createElement("p");c.className="sidebar__item--subtitle",c.innerHTML=a.address;var m=document.createElement("div");m.className="sidebar__item--badge";var u=document.createElement("div");u.className="text-center bg-"+o.toString().toLowerCase()+"min",u.innerHTML="<span>"+p+"</span><br/>Last update <time>"+i+"</time>",m.appendChild(u);var g=document.createElement("div");g.setAttribute("onclick","TimesApp.mapMarkers['"+e+"'].fireEvent('click')"),g.className="sidebar__item",g.setAttribute("title",a.name+" "+a.address+" - wait time: "+o+"min"),g.appendChild(d),g.appendChild(c),g.appendChild(m),t.appendChild(g)}},showPlaceModal:function(e,t){console.log(e);var a=document.getElementById("place-modal");a.classList.add("show"),a.focus(),a.setAttribute("data-place-id",e.place_id);var s="recent";if(void 0!==e.updatetime){var i=new Date(1e3*e.updatetime);s=i.getHours()+":"+("0"+i.getMinutes()).substr(-2)}var n=t[1],o=0===t[0],r="string"==typeof n&&!o;n=o?"Closed":n,document.querySelector(".place-modal__title").innerHTML=e.name,document.querySelector(".place-modal__subtitle").innerHTML=e.address;var l=document.querySelector(".place-modal__badge div"),p=o?"Closed":n+" min";p=r?"No info":p,l.setAttribute("class","text-center bg-"+n.toString().toLowerCase()+"min"),document.querySelector("#time-min").innerHTML=p,document.querySelector("#place-modal time").innerHTML=s,document.querySelector("#time-range").value=t[1]},hidePlaceModal:function(e){e=e||!1;var t=document.getElementById("place-modal");t.classList.remove("show"),e&&Utils.sendFeedback({place_id:t.getAttribute("data-place-id"),value:{estimate_person:0,estimate_wait_min:parseInt(document.querySelector("#time-range").value)}})},searchByNameModal:function(){null!==document.querySelector(".modal")&&document.body.removeChild(document.querySelector(".modal")),Utils.openModal("search-modal","Search by name and address",'<input type="text" placeholder="Insert market or place name" id="place"><input type="text" placeholder="Insert address or city" id="address">',"Search",function(){if(""==document.getElementById("place").value||""==document.getElementById("address").value)return alert("Please, specify a place name and a place address."),!1;TimesApp.getPlace(document.getElementById("place").value,document.getElementById("address").value),document.body.removeChild(document.querySelector(".modal"))})},openModal:function(e,t,a,s,i,n){e=e||(new Date).getTime();var o=t,r=(s=s||"Send",document.createElement("div"));r.id=e,r.className="modal";var l=document.createElement("div");l.className="modal-content animate-opacity card-4",r.appendChild(l);var p=document.createElement("header");p.className="container teal",l.appendChild(p);var d=document.createElement("div");d.className="container",l.appendChild(d),d.innerHTML=a||'<p>Did not find what you were looking for? <br/><u style="cursor: pointer" onclick="Utils.searchByNameModal()">Tap here to search by name üîç</u></p><input type="text" id="email" placeholder="Insert an email for an answer or leave blank" /><textarea placeholder="Write here your question or tips" rows="7"></textarea><small><i>Note: this is not a search box</i></small>';var c=document.createElement("button");c.setAttribute("type","button"),c.className="close-button display-topright",c.setAttribute("onclick","document.getElementById('"+e+"').style.display='none'"),c.innerHTML="&times;",p.appendChild(c);var m=document.createElement("H2");m.innerHTML=o,p.appendChild(m);var u=document.createElement("div");u.className="container teal",l.appendChild(u);var g=document.createElement("button");if(g.setAttribute("type","button"),g.className="btn",-1!==s&&(g.style.float="right"),void 0===n?g.setAttribute("onclick","document.getElementById('"+e+"').style.display='none'"):g.addEventListener("click",n),g.innerHTML="Close",u.appendChild(g),-1!==s){var A=document.createElement("button");A.setAttribute("type","button"),A.className="btn",void 0===i?A.setAttribute("onclick","TimesApp.sendHelp(document.querySelector('.modal-content textarea').value, document.querySelector('.modal-content #email').value)"):A.addEventListener("click",i),A.innerHTML=s,u.appendChild(A)}r.style.display="flex",document.getElementsByTagName("body")[0].appendChild(r)},getAccurateCurrentPosition:function(e,t,a,s){var i,n,o,r=0,l=function(t){e(t)};(s=s||{}).maxWait||(s.maxWait=1e4),s.desiredAccuracy||(s.desiredAccuracy=20),s.timeout||(s.timeout=s.maxWait),s.maximumAge=0,s.enableHighAccuracy=!0,n=navigator.geolocation.watchPosition(function(e){i=e,r+=1,e.coords.accuracy<=s.desiredAccuracy&&r>1?(clearTimeout(o),navigator.geolocation.clearWatch(n),l(e)):a(e)},function(e){clearTimeout(o),navigator.geolocation.clearWatch(n),t(e)},s),o=setTimeout(function(){navigator.geolocation.clearWatch(n),l(i)},s.maxWait)},destinationPoint:function(e,t,a,s){s/=6371,a=a.toRad();var i=e.toRad(),n=t.toRad(),o=Math.asin(Math.sin(i)*Math.cos(s)+Math.cos(i)*Math.sin(s)*Math.cos(a)),r=n+Math.atan2(Math.sin(a)*Math.sin(s)*Math.cos(i),Math.cos(s)-Math.sin(i)*Math.sin(o));return isNaN(o)||isNaN(r)?null:[o.toDeg(),r.toDeg()]},toggleLegend:function(e){"none"==document.getElementById("legend-values").style.display?(document.getElementById("legend-values").style.display="block",e.innerHTML="Legend ‚ñæ"):(document.getElementById("legend-values").style.display="none",e.innerHTML="Legend ‚ñ¥")},distanceLatLng:function(e,t,a,s){var i=(a-e).toRad(),n=(s-t).toRad(),o=(e=e.toRad(),a=a.toRad(),Math.sin(i/2)*Math.sin(i/2)+Math.sin(n/2)*Math.sin(n/2)*Math.cos(e)*Math.cos(a));return 6371*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}},TimesApp={startBoundIndex:361,mapMarkers:{},menuPlaces:{},lat:null,lng:null,address:"",zoom:15,lMap:null,myPosition:null,query:"supermarket",isLoading:!1,place_ids:[],icons:[],fullEstimation:!0,setLoading:function(e){TimesApp.isLoading=e;var t=!0===e?"block":"none";document.getElementById("top-progress-bar").style.display=t},initIcon:function(){const e=["0","1","2","3","4","5","6","7","8"];for(const t in e)TimesApp.icons.push(L.icon({iconUrl:"/assets/custom-marker/"+e[t]+".png",iconSize:[42,42],iconAnchor:[20,32],popupAnchor:[2,-20]}))},initMap:function(){TimesApp.toggleSpinner(),TimesApp.initIcon(),TimesApp.lMap=L.map("full-map").setView([TimesApp.lat,TimesApp.lng],TimesApp.zoom),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,minZoom:13,attribution:'Map data <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'}).addTo(TimesApp.lMap),TimesApp.myPosition=L.circle([TimesApp.lat,TimesApp.lng],{color:"#0696c1",fillColor:"#06aee0",fillOpacity:.5,radius:50}).bindPopup("Your position").addTo(TimesApp.lMap),TimesApp.lMap.on("moveend zoomend",async function(e){clearTimeout(Utils.updateTimeout);let t=TimesApp.lMap.getCenter();console.log("new center ",t.toString()),console.log(e.type),(Utils.distanceLatLng(TimesApp.lat,TimesApp.lng,t.lat,t.lng)>=2.5||"zoomend"==e.type)&&(TimesApp.lat=parseFloat(t.lat),TimesApp.lng=parseFloat(t.lng),Utils.updateTimeout=setTimeout(async function(){await TimesApp.updateAddress(-1),TimesApp.getPlaces(null,!0),await TimesApp.updateBound(TimesApp.lat,TimesApp.lng),TimesApp.getPharmacies()},1e3))}),TimesApp.showLegend(),TimesApp.getPlaces(null,!0)},getMarkerPlaceColor:function(e){return e>60?[6,"#cc0c33"]:e>45?[5,"#ff2929"]:e>30?[4,"#fa4c25"]:e>25?[3,"#fc7e2a"]:e>15?[2,"#ffbf1c"]:e>10?[1,"#ecf716"]:[0,"#1fcc00"]},showLegend:function(){var e=L.control({position:"bottomleft"});e.onAdd=function(e){var t,a,s=L.DomUtil.create("div","info legend"),i=[5,10,15,25,30,45,60],n=[];n.push('<i style="background: #3f8ee2"></i> No info');for(var o=0;o<i.length;o++)t=i[o],a=i[o+1],n.push('<i style="background:'+TimesApp.getMarkerPlaceColor(i[o]+1)[1]+'"></i> '+t+(a?"&ndash;"+a:"+"));return s.innerHTML='<span onclick="Utils.toggleLegend(this)">Legend ‚ñ¥</span><div style="display: none" id="legend-values"><u>Minutes</u>:<br>'+n.join("<br>")+"</div>",s},e.addTo(TimesApp.lMap)},getWaitTime:function(e){const t=(new Date).getHours(),a=0===(new Date).getDay()?6:(new Date).getDay()-1;var s=meanTimeSpent=minTimeSpent=0;void 0!==e.time_spent&&e.time_spent.length>0&&(e.time_spent[0]=1==e.time_spent[0]?60:e.time_spent[0],e.time_spent[1]=1==e.time_spent[1]?60:e.time_spent[1],s=Math.max(...e.time_spent),minTimeSpent=Math.min(...e.time_spent),meanTimeSpent=e.time_spent.reduce(function(e,t){return e+t},0)/2);const i=e.current_popularity||0;var n=popTimes=0;void 0!==e.time_wait&&e.time_wait.length>0&&(n=e.time_wait[a].data[t]),popTimes=e.populartimes[a].data[t],(new Date).getMinutes()>=40&&void 0!==e.populartimes[a].data[t+1]&&0!=e.populartimes[a].data[t+1]&&(popTimes=Math.floor((popTimes+e.populartimes[a].data[t+1])/2));var o=0;const r=popTimes-i;var l=popTimes>0?meanTimeSpent:0;0!==i?popTimes/i<=3.3?r<=0&&p>10?l=s+5*Math.ceil(i/2/5):r>0&&r<popTimes/5?l=meanTimeSpent:r>=popTimes/5&&r<=popTimes/2.9?l=minTimeSpent:r>popTimes/2.9&&r<=popTimes/1.8?l=5*Math.ceil(minTimeSpent/2/5):r>popTimes/1.8&&r<=popTimes/1.5?l=5*Math.ceil(minTimeSpent/3/5):r>popTimes/1.5&&(l=0,n=5*Math.ceil(20*n/100/5)):i>=popTimes/3.3?l=minTimeSpent:(n=0,l=5):0==n?l=0:0==i&&0==TimesApp.fullEstimation&&(p=0,l=0),o+=l;var p=Math.ceil(n+o);return 0!==popTimes&&i>=18&&(p+=5),0!==p||0!==meanTimeSpent&&0!==i||(p="No information about "),[e.populartimes[a].data[t],p]},getPharmacies:function(){console.log("Getting pharmacy")},getPlace:function(e,t){TimesApp.setLoading(!0);const a=WaitingTimesAPI.format(WaitingTimesAPI.getPlaceByNameAPI,e,t);ga("send","event","Request","Place",e+" "+t),fetch(a).then(e=>{if(e.ok)return e.json()}).then(t=>{TimesApp.setPlaceOnMap(t),void 0!==TimesApp.mapMarkers[t[0].place_id]?(TimesApp.lMap.setView([t[0].coordinates.lat,t[0].coordinates.lng],TimesApp.zoom),TimesApp.mapMarkers[t[0].place_id].fireEvent("click")):alert("Unfortunally "+e+" does not have any information about waiting times")}).catch(e=>Utils.sendError({url:a,singlePlace:!0,message:e.toString()}))},getPlacesFallback:async function(){const e=WaitingTimesAPI.format(WaitingTimesAPI.getPlacesAPI.replace("api-geo-fr","api-geo-uk").replace("api-geo-ny","api-geo-uk"),TimesApp.query,TimesApp.address);ga("send","event","Request","Places",TimesApp.address),fetch(e).then(e=>{if(e.ok)return e.json()}).then(e=>TimesApp.setPlaceOnMap(e)).catch(t=>Utils.sendError({url:e,message:t.toString()}))},getPlaces:function(e,t){e=e||TimesApp.query,t=t||!1;if(TimesApp.setLoading(!0),t){var a=new Headers;a.append("x-geo-lat",TimesApp.lat),a.append("x-geo-lng",TimesApp.lng);const t=WaitingTimesAPI.format(WaitingTimesAPI.getPlacesAPIFallback,e,TimesApp.address);ga("send","event","Request","Places",TimesApp.address),fetch(t,{headers:a}).then(e=>{if(e.ok)return e.json()}).then(e=>{TimesApp.startBoundIndex=e.length<=40?120:361,TimesApp.setPlaceOnMap(e),TimesApp.updateBound(TimesApp.lat,TimesApp.lng)}).catch(e=>TimesApp.getPlacesFallback())}else{var s=WaitingTimesAPI.getPlacesAPI;const t=WaitingTimesAPI.format(s,e,TimesApp.address);ga("send","event","Request","Places",TimesApp.address),fetch(t).then(e=>{if(e.ok)return e.json()}).then(e=>TimesApp.setPlaceOnMap(e)).catch(e=>TimesApp.getPlacesFallback())}},setPlaceOnMap:function(e){console.log(e),TimesApp.setLoading(!1);var t=[];e>=80&&(TimesApp.menuPlaces={});for(const i in e){if(void 0===e[i].populartimes)continue;let n=TimesApp.getWaitTime(e[i]),o=n[1],r=TimesApp.getMarkerPlaceColor(o),l="<b>"+e[i].name+"</b><br><small>"+e[i].address+"</small><br/><i>"+o+"min</i> of line";if(0===n[0]&&(r=["7","#777"],l="<i>Closed</i><br/>"+l),void 0!==e[i].user_feedback&&void 0!==e[i].user_feedback.estimate_wait_min&&(o=e[i].user_feedback.estimate_wait_min,n[1]=o,r=TimesApp.getMarkerPlaceColor(o),e[i].updatetime=e[i].user_feedback.updatetime),void 0!==e[i].updatetime){var a=new Date(1e3*e[i].updatetime);l+=" - <i>Last update at</i> "+(a.getHours()+":"+("0"+a.getMinutes()).substr(-2))}var s="string"==typeof o&&"7"!=r[0]?TimesApp.icons[8]:TimesApp.icons[r[0]];const p=L.marker([e[i].coordinates.lat,e[i].coordinates.lng],{icon:s});-1!==TimesApp.place_ids.indexOf(e[i].place_id)&&(TimesApp.mapMarkers[e[i].place_id].setIcon(s),TimesApp.mapMarkers[e[i].place_id].removeEventListener("click")),p.addTo(TimesApp.lMap).on("click",function(){Utils.showPlaceModal(e[i],n)}),t.push(p),TimesApp.menuPlaces[e[i].place_id]={data:e[i],waitTimeArr:n},TimesApp.mapMarkers[e[i].place_id]=p,TimesApp.place_ids.push(e[i].place_id)}return t},updateAddressAwait:async function(e){e=e||!0;var t=await fetch(WaitingTimesAPI.format(WaitingTimesAPI.geocodeAPI,TimesApp.lat,TimesApp.lng));(t=t.ok?await t.json():{staddress:"",city:""}).staddress="object"==typeof t.staddress||void 0===t.staddress?"":t.staddress,t.city="object"==typeof t.city||void 0===t.city?"":t.city,TimesApp.address=""!==t.staddress?t.staddress+", ":"",TimesApp.address+=t.city,!0===e?TimesApp.initMap():TimesApp.getPlaces(),ga("send","event","Request","Geocode",WaitingTimesAPI.geocodeAPI)},updateAddress:async function(e){e=e||!0,TimesApp.setLoading(!0);var t=WaitingTimesAPI.format(WaitingTimesAPI.geocodeAPIClient,TimesApp.lng,TimesApp.lat),a=1;5==Math.floor(15*Math.random())&&(a=0,t=WaitingTimesAPI.format(WaitingTimesAPI.geocodeAPI,TimesApp.lat,TimesApp.lng));var s=await fetch(t),i={staddress:"",city:""};if(!s.ok){let e=await s.json();return Utils.sendError({url:t,updateAddress:!0,message:e.toString()}),!1}(i=await s.json()).staddress="object"==typeof i.staddress||void 0===i.staddress?"":i.staddress,i.city="object"==typeof i.city||void 0===i.city?"":i.city,""===i.staddress&&void 0!==i.address&&(i.staddress=void 0===i.address.Address?"":i.address.Address),""===i.city&&void 0!==i.address&&(i.city=void 0===i.address.City?"":i.address.City),TimesApp.address=""!==i.staddress?i.staddress+", ":"",TimesApp.address+=i.city,!0===e?TimesApp.initMap():TimesApp.getPlaces(),ga("send","event","Request","Geocode",0==a?WaitingTimesAPI.geocodeAPI:WaitingTimesAPI.geocodeAPIClient)},updateBound:async function(e,t){TimesApp.setLoading(!0);for(var a=361;a<=360;a+=120){let s=Utils.destinationPoint(e,t,a,2.5);TimesApp.lat=parseFloat(s[0]),TimesApp.lng=parseFloat(s[1]),await new Promise(e=>setTimeout(e,3e3)),await TimesApp.updateAddress(-1)}TimesApp.setLoading(!1)},geoSuccess:async function(e){if(void 0===e)return TimesApp.geoError(),!1;TimesApp.lat=parseFloat(e.coords.latitude),TimesApp.lng=parseFloat(e.coords.longitude),await TimesApp.updateAddressAwait(),await TimesApp.updateBound(TimesApp.lat,TimesApp.lng),ga("send","event","Geolocation","GeoSuccess","true")},showModalHelp:function(){null!==document.querySelector(".modal")&&document.body.removeChild(document.querySelector(".modal")),Utils.openModal("help-modal","Need help? Do you want to ask something?")},sendReview:function(e){e=e||"0";ga("send","event","Review","Rate",e),Utils.sendError({rate:e}),localStorage.setItem("sended_review","yes"),document.querySelector(".modal-content div.container").innerHTML="<h2>Feedback sent, thank you!</h2>",setTimeout(function(){document.body.removeChild(document.getElementById("rating-modal"))},1200)},sendHelp:function(e,t){t=t||"";""!=e&&""!=t&&Utils.sendError({message:e,email:t,help:!0}),document.querySelector(".modal-content div.container").innerHTML="<h2>Message sent, thank you!</h2>",setTimeout(function(){document.getElementById("help-modal").style.display="none"},1200)},fallbackGeocodeCall:async function(e){var t=await fetch(WaitingTimesAPI.format(WaitingTimesAPI.fallbackGeocodeAPI,e)),a=await t.json();return a.length>0&&void 0!==a[0].lat?(a.latt=a[0].lat,a.longt=a[0].lon):a.error=!0,a},search:async function(){if(TimesApp.address=prompt("This app need your gps position or at least your address or your city:",""),null===TimesApp.address)return!1;if(TimesApp.setLoading(!0),""!=TimesApp.address){ga("send","event","Request","Search",TimesApp.address);const a="https://geocode.xyz/"+TimesApp.address+"?json=1";var e=await fetch(a),t=await e.json();if((!e.ok||void 0!==t.error&&"006"===t.error.code)&&(t=await TimesApp.fallbackGeocodeCall(TimesApp.address)),void 0!==t.error)return setTimeout(function(){alert("No results. Check your address/city and try again. Please write the city in english"),Utils.sendError({url:a,search:!0,message:t.error}),TimesApp.search()},2e3),!1;TimesApp.lat=parseFloat(t.latt),TimesApp.lng=parseFloat(t.longt),TimesApp.getPlaces(null,!0),TimesApp.lMap.setView([TimesApp.lat,TimesApp.lng],TimesApp.zoom),TimesApp.updateBound(TimesApp.lat,TimesApp.lng)}},promptAddress:function(){return prompt("This app need your gps position or at least your address or your city:","")},geoError:async function(e){if(clearTimeout(Utils.geoErrorTimeout),TimesApp.address=TimesApp.promptAddress(),null===TimesApp.address?(Utils.geoErrorFailOverCount+=1,TimesApp.lat=43.7740236,TimesApp.lng=11.253233,TimesApp.address="Firenze",null===TimesApp.lMap&&TimesApp.initMap(),Utils.geoErrorFailOverCount<2&&(Utils.geoErrorTimeout=setTimeout(function(){TimesApp.geoError()},1e3))):TimesApp.address=TimesApp.address.trim(),""!=TimesApp.address){ga("send","event","Geolocation","GeoError",TimesApp.address);const e="https://geocode.xyz/"+TimesApp.address+"?json=1";var t=await fetch(e),a=await t.json();if((!t.ok||void 0!==a.error&&"006"===a.error.code)&&(a=await TimesApp.fallbackGeocodeCall(TimesApp.address)),void 0!==a.error)return setTimeout(function(){alert("No results. Check your address/city and try again. Please write the city in english"),Utils.sendError({url:e,geoError:!0,message:a.error}),TimesApp.geoError()},2e3),!1;TimesApp.lat=parseFloat(a.latt),TimesApp.lng=parseFloat(a.longt),null===TimesApp.lMap?(TimesApp.initMap(),TimesApp.updateBound(TimesApp.lat,TimesApp.lng)):(TimesApp.getPlaces(null,!1),TimesApp.updateBound(TimesApp.lat,TimesApp.lng))}},initGeodata:function(){TimesApp.toggleSpinner(),Utils.getAccurateCurrentPosition(TimesApp.geoSuccess,TimesApp.geoError,function(e){console.log(e)},{desiredAccuracy:100,maxWait:8e3})},toggleSpinner:function(){const e=document.getElementById("loading");let t="block";"block"==e.style.display&&(t="none"),e.style.display=t}};document.addEventListener("DOMContentLoaded",function(){Utils.shouldShowWelcomeModal()?Utils.showWelcomeModal():TimesApp.initGeodata(),document.getElementById("full-map").style.height=window.innerHeight+"px",setTimeout(function(){document.getElementById("banner").style.display="none"},3e4),setTimeout(function(){TimesApp.getPlaces(null,!0)},3e5),"yes"!==localStorage.getItem("sended_review")&&setTimeout(function(){Utils.openModal("rating-modal","Please, take time to rate this project",'\n        <h4>Your feedback is very important to understand if the estimates are correct or not. Together we can build something useful!</h4>\n        <div class="rate">\n          <input type="radio" id="star5" name="rate" value="5">\n          <label onclick="TimesApp.sendReview(this.getAttribute(\'data-value\'))" for="star5" data-value="5" title="5 stars"><span class=\'sr-only\'>5 stars</span></label>\n          <input type="radio" id="star4" name="rate" value="4">\n          <label onclick="TimesApp.sendReview(this.getAttribute(\'data-value\'))" for="star4" data-value="4" title="4 stars"><span class=\'sr-only\'>4 stars</span></label>\n          <input type="radio" id="star3" name="rate" value="3">\n          <label onclick="TimesApp.sendReview(this.getAttribute(\'data-value\'))" for="star3" data-value="3" title="3 stars"><span class=\'sr-only\'>3 stars</span></label>\n          <input type="radio" id="star2" name="rate" value="2">\n          <label onclick="TimesApp.sendReview(this.getAttribute(\'data-value\'))" for="star2" data-value="2" title="2 stars"><span class=\'sr-only\'>2 stars</span></label>\n          <input type="radio" id="star1" name="rate" value="1">\n          <label onclick="TimesApp.sendReview(this.getAttribute(\'data-value\'))" for="star1" data-value="1" title="1 star"><span class=\'sr-only\'>1 star</span></label>\n        </div>\n      ',-1)},12e4)}),window.onerror=function(e,t,a){const s={date:(new Date).toString(),ua:navigator.userAgent,errorMessage:e,errorUrl:t,errorLine:a};Utils.sendError(s)},window.addEventListener("appinstalled",function(){ga("send","event","PWA","Installed","true"),Utils.sendError({pwa_installed:!0})}),function(e,t,a,s,i,n,o){e.GoogleAnalyticsObject=i,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,n=t.createElement(a),o=t.getElementsByTagName(a)[0],n.async=1,n.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(n,o)}(window,document,"script",0,"ga"),ga("create","UA-10999521-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");try{navigator.serviceWorker.register("sw.js")}catch(e){console.log(e)}